#!/bin/bash

# update the system
apt update

# add dependencies
apt -y install git curl wget libnewt-dev libssl-dev libncurses5-dev subversion libsqlite3-dev build-essential libjansson-dev libxml2-dev uuid-dev

# download and extract Asterisk 20
cd /usr/src && curl -O https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-20-current.tar.gz
tar xvf asterisk-20-current.tar.gz
cd asterisk-20.*

# download MP3 decoder library
contrib/scripts/get_mp3_source.sh

# make sure all dependencies are resolved
contrib/scripts/install_prereq install

# configure asterisk
./configure

# setup menu options
make menuselect

# build
make

# install
make install

# install samples and configs
make samples && make config && make ldconfig

# add asterisk group, user
groupadd asterisk
useradd -r -d /var/lib/asterisk -g asterisk asterisk
usermod -aG audio,dialout asterisk

# set permissions
chown -R asterisk.asterisk /etc/asterisk
chown -R asterisk.asterisk /var/{lib,log,spool}/asterisk
chown -R asterisk.asterisk /usr/lib/asterisk

# set "asterisk" as default user, then restart
echo -e "\n\n# installer\nAST_USER=\"asterisk\"\nAST_GROUP=\"asterisk\"" >> /etc/default/asterisk

# before enabling asterisk service we need to fix radiuscfg by fixing the path
sed -i 's|;\[radius\]|[radius]\nradiuscfg => /etc/radcli/radiusclient.conf\n|' /etc/asterisk/cdr.conf
echo -e "\n\n\n# installer\nradiuscfg => /etc/radcli/radiusclient.conf" >> /etc/asterisk/cel.conf

# enable asterisk service and restart
systemctl enable asterisk
systemctl restart asterisk

# how To Remove Asterisk
# rm -r /usr/src/asterisk-20.*

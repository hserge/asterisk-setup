#!/bin/bash

# update the system
apt update

# add dependencies
apt -y install git curl wget libnewt-dev libssl-dev libncurses5-dev subversion libsqlite3-dev build-essential libjansson-dev libxml2-dev uuid-dev

# download and extract Asterisk 20
cd /usr/src && curl -O https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-20-current.tar.gz
tar xvf asterisk-20-current.tar.gz
cd asterisk-20.*

# download MP3 decoder library
contrib/scripts/get_mp3_source.sh

# make sure all dependencies are resolved
contrib/scripts/install_prereq install

# configure asterisk
./configure

# deactivate menuselect options we dont need
ENABLE_OPTIONS="format_mp3 smsq CORE-SOUNDS-EN-WAV CORE-SOUNDS-EN-ULAW CORE-SOUNDS-EN-G729 MOH-OPSOUND-WAV MOH-OPSOUND-ULAW MOH-OPSOUND-G729 EXTRA-SOUNDS-EN-WAV EXTRA-SOUNDS-EN-ULAW EXTRA-SOUNDS-EN-G729"
for option in $ENABLE_OPTIONS ; do
menuselect/menuselect --enable $option menuselect.makeopts
done

DISABLE_OPTIONS="cdr_radius cel_radius app_adsiprog app_getcpeid res_adsi res_config_ldap res_config_pgsql res_phoneprov"
for option in $DISABLE_OPTIONS ; do
menuselect/menuselect --disable $option menuselect.makeopts
done

# setup/check menu options
make menuselect

# build
make

# install
make install

# install samples and configs
make samples && make config && make ldconfig

# add asterisk group, user
groupadd asterisk
useradd -r -d /var/lib/asterisk -g asterisk asterisk
usermod -aG audio,dialout asterisk

# set permissions
chown -R asterisk.asterisk /etc/asterisk
chown -R asterisk.asterisk /var/{lib,log,spool}/asterisk
chown -R asterisk.asterisk /usr/lib/asterisk

# set "asterisk" as default user, then restart
echo -e "\n\n# installer\nAST_USER=\"asterisk\"\nAST_GROUP=\"asterisk\"" >> /etc/default/asterisk

# enable asterisk service and restart
systemctl enable asterisk
systemctl restart asterisk

# how To Remove Asterisk
# killall -9 safe_asterisk
# killall -9 asterisk
# systemctl disable asterisk
# rm -r /usr/src/asterisk-20.* /etc/asterisk /var/log/asterisk /var/lib/asterisk /var/spool/asterisk /usr/lib/asterisk
